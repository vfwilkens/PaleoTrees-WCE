---
title: "Prepare data for niche centers and create plots for Fig. 4"
output:
  html_document:
    df_print: paged
---

Load in necessary libraries.
```{r, eval = FALSE}
library(brms)
library(dplyr)
library(ggplot2)
library(here)
library(terra)
library(patchwork)
```

Load in fossil data, global tree genus checklist, and native species/genus checklists for WCE.
```{r}
dataset_final <- readxl::read_xlsx(here("./data/data_1/dataset_final_28_06_25.xlsx"))
native_genera <- read.csv(here("./data/data_1/native_genera.csv"))[,-1]
native_species <- read.csv(here("./data/data_1/native_species.csv"))[,-1]
trees_final <- read.csv(here("./data/data_1/trees_final.csv"))
```

Load in climate data for WCE and reproject into equal-area projection EPSG:3035.
```{r}
bioclim_current <- rast(here("./data/data_3/bioclim_current_0_25deg.tif"))
bioclim_ssp126 <- rast(here("./data/data_3/bioclim_ssp126_0_25deg.tif"))
bioclim_ssp585 <- rast(here("./data/data_3/bioclim_ssp585_0_25deg.tif"))

bioclim_current <- project(bioclim_current, "EPSG:3035")
bioclim_ssp126 <- project(bioclim_ssp126, "EPSG:3035")
bioclim_ssp585 <- project(bioclim_ssp585, "EPSG:3035")

bioclim_current_df <- as.data.frame(bioclim_current, xy = TRUE)
colnames(bioclim_current_df) <- c("x","y","bio1","bio2","bio3","bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")

bioclim_ssp126_df <- as.data.frame(bioclim_ssp126, xy = TRUE)
colnames(bioclim_ssp126_df) <- c("x","y","bio1","bio2","bio3","bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")

bioclim_ssp585_df <- as.data.frame(bioclim_ssp585, xy = TRUE)
colnames(bioclim_ssp585_df) <- c("x","y","bio1","bio2","bio3","bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")

bioclim_current_df$group <- "current"
bioclim_ssp126_df$group <- "ssp126"
bioclim_ssp585_df$group <- "ssp585"

combined_data <- rbind(bioclim_current_df, bioclim_ssp126_df, bioclim_ssp585_df)
combined_data <- na.omit(combined_data)
```

Prepare data for Fig. 4 by loading in all models of niche centers and extracting desired information, including the genus-level fixed intercepts, Rhat, number of divergent transitions, and number of species used to fit the models.
```{r}
#Input directory
directory_path <- here("./data/niche_centers")

file_paths <- list.files(directory_path, full.names = TRUE)
model_list <- lapply(file_paths, readRDS)

model_names <- sub(".*model_(.*)\\.RData", "\\1", file_paths)
genus_names <- sub("_na$", "", model_names)

#Define function to extract the number of divergent transitions from each model object.
n_divergent <- function(x) {
  stopifnot(is(x, "brmsfit"))
  out <- lapply(x$fit@sim$samples, function(y) 
    sum(attr(y, "sampler_params")[["divergent__"]]))
  sum(unlist(out))
}

#Initialize dataframe
all_data_centers <- data.frame()

#Loop through all models by loading in the model object and extracting desired information.
for(g in 1:length(genus_names)){
genus_name <- genus_names[[g]]
model_name <- model_names[[g]]
model <- model_list[[g]]
Rhat <- max(rhat(model))
species_n <- length(unique(model$data$species))
divtrans <- n_divergent(model)

#If the model in question is monospecific, the format is different:
if(ncol(as_draws_df(model)) == 11){
  para <- as_draws_df(model)
  para <- select(para, b_bio1_Intercept, b_bio12_Intercept)
  para <- colMeans(para)
  df <- data.frame(genus = genus_name, model = model_name, bio1 = para[1], bio12 = para[2], Rhat = Rhat, n = species_n, divtrans = divtrans)
  all_data_centers <- rbind(all_data_centers, df)
  next
  }

para <- as_draws_df(model)
para <- select(para, b_bio1_Intercept, b_bio12_Intercept)
para <- colMeans(para) 
df <- data.frame(genus = genus_name, model = model_name, bio1 = para[1], bio12 = para[2], Rhat = Rhat, n = species_n, divtrans = divtrans)

all_data_centers <- rbind(all_data_centers, df)

}

all_data_centers$category <- ifelse(all_data_centers$genus %in% native_species | grepl("_na$", all_data_centers$model), "HRTF",
                                    ifelse(all_data_centers$genus %in% native_genera, "EG", "REG"))


all_data_centers$n <- ifelse(all_data_centers$n == 0, 1, all_data_centers$n)

all_data_centers$plot_Rhat <- ifelse(all_data_centers$Rhat <= 1.05, 1, 0)
all_data_centers$plot_divtrans <- ifelse(all_data_centers$divtrans <= 40, 1, 0)

paleotrees_adj <- dataset_final
paleotrees_adj$last_presence <- apply(paleotrees_adj[,-1], 1, function(x) {
  if(any(x == 1)) names(x)[max(which(x == 1))] else NA
})

all_data_centers <- merge(all_data_centers, paleotrees_adj[,c(1,13)], by = "genus")
all_data_centers$last_presence <- ifelse(all_data_centers$last_presence %in% c("Eem","Tegelen","Waal","Cromer","Holstein"), "Pleistocene", all_data_centers$last_presence)

all_data_centers$label <- all_data_centers$genus
all_data_centers$label <- paste0("italic('", all_data_centers$label, "')")

all_data_centers$label <- with(all_data_centers, paste0(label, "[", 
  ifelse(category == "HRTF", "\"nat.\"",""),"]"))

total_species <- data.frame()
for(g in 1:length(genus_names)) {
  genus_name <- genus_names[[g]]
  model_name <- model_names[[g]]
  
  if (genus_name != model_name) {
    species_list <- filter(trees_final, trees_final$genus == genus_name)
    species_list <- filter(species_list, species_list$species %in% native_species)
    df <- data.frame(model = model_name, n_total = nrow(species_list))
    total_species <- rbind(total_species, df)
  }
  
  if (genus_name == model_name) {
    species_list <- filter(trees_final, trees_final$genus == genus_name)
    df <- data.frame(model = model_name, n_total = nrow(species_list))
    total_species <- rbind(total_species, df)
  }
}

all_data_centers <- merge(all_data_centers, total_species, by = "model")


```

Create the plot for Fig. 4a:
```{r}
#Define a list of genera whose labels will be plotted
plot_labels <- c("Picea_na","Picea", "Cedrus","Pseudotsuga","Aesculus","Juglans","Castanea", "Phoenix", "Ziziphus", "Taiwania", "Tsuga", "Areca", "Meliosma", "Eugenia","Tetraclinis", "Hippophae_na", "Hippophae","Fagus","Fagus_na","Picea","Picea_na","Acer","Acer_na")
all_data_centers$plot_label <- ifelse(all_data_centers$model %in% plot_labels, 1, 0)


p1 <- ggplot() +
geom_point(data = combined_data, aes(x = bio1, y = bio12, color = group, fill = group), alpha = 0.025, size = 4, shape =15 ) +
geom_point(data = all_data_centers[all_data_centers$plot_Rhat == 1 & all_data_centers$plot_divtrans == 1,], 
           aes(x = bio1, y = bio12, fill = category, size = n_total, shape = category), 
           color = "black", 
           stroke = 0.5) +
geom_text(data = all_data_centers[all_data_centers$plot_label == 1,], aes(x = bio1, y = bio12, label = label), parse = TRUE) +
  stat_ellipse(data = all_data_centers[all_data_centers$category == "HRTF",], aes(x = bio1, y = bio12), color = "black", linetype = "longdash") +
  scale_color_manual(values = c("current"="#909090", "EG"="#FFD579","HRTF"= "#237B55","REG"= "#69A0C9","ssp126"="#FF9538","ssp585"="#EB0000")) +
  scale_fill_manual(values = c("current"="#909090", "EG"="#FFD579","HRTF"= "#237B55","REG"= "#69A0C9","ssp126"="#FF9538","ssp585"="#EB0000")) +
  scale_size_continuous(range = c(2, 14), limits = c(1, 850), breaks = c(1,5,10,50,100)) +  
  scale_linetype_manual(values = c("longdash","solid","dotted")) +
  scale_shape_manual(values = c("EG"=21, "HRTF"=24, 
                                "REG"=21)) +  
  theme_minimal() +
theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"),
    axis.text.x = element_text(size = 22, colour = "black"),
    axis.text.y = element_text(size = 22, colour = "black"),
    axis.title.y = element_blank(),
    axis.ticks.length = unit(0.5, "cm"),
    axis.ticks.x = element_line(colour = "black"),  
    axis.ticks.y = element_line(colour = "black")  
)


ggsave(plot = p1, filename = "Fig4a_niche_centers.pdf", path = here("figures"), width = 12, height = 12, device='pdf', dpi=700, bg = "white")
```

Create the plot for Fig. 4b:
```{r}

colors_periods <- c("Holocene" = "#DCE8E9", 
                    "Eem" = "#CBF5FC",
                    "Holstein" = "#B4E2E3",
                    "Cromer" = "#99D9DD",
                    "Waal" = "#7FC5DD",
                    "Tegelen" = "#4FB3D4",
                    "Pliocene" = "#FFF6B2",
                    "Miocene" = "#FFEB3D",
                    "Oligocene" = "#FFC694",
                    "Eocene" = "#FFBC87",
                    "Pleistocene" = "#99d9ddff")



p2 <- ggplot() +
geom_point(data = all_data_centers[all_data_centers$plot_Rhat == 1 & all_data_centers$plot_divtrans == 1,], 
           aes(x = bio1, y = bio12, fill = last_presence, size = n_total, shape = category), 
           color = "black", 
           stroke = 0.5) +
  scale_fill_manual(values = colors_periods) +
  scale_size_continuous(range = c(2, 8), limits = c(1, 850), breaks = c(1,5,10,50,100)) +  
  stat_ellipse(data = all_data_centers[all_data_centers$category == "HRTF",], aes(x = bio1, y = bio12), color = "black", linetype = "longdash") +
  scale_shape_manual(values = c("EG"=21, "HRTF"=24, 
                               "REG"=21)) +  
  ylim(0, 3500) +
  theme_minimal() +
theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(colour = "black"),
    axis.line.y = element_line(colour = "black"),
    axis.text.x = element_text(size = 22, colour = "black"),
    axis.text.y = element_text(size = 22, colour = "black"),
    axis.title.y = element_blank(),
    axis.ticks.length = unit(0.5, "cm"), 
    axis.ticks.x = element_line(colour = "black"),  
    axis.ticks.y = element_line(colour = "black")  
)

ggsave(plot = p2, filename = "Fig4b_last_occurrences.pdf", path = here("figures"), width = 6, height = 6, device='pdf', dpi=700, bg = "white")

```





